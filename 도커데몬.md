# 도커 데몬


## 1. 도커의 구조
- 도커의 구조는 **클라이언트로서의 도커**와 **서버로서의 도커**로 나뉜다.
  - 실제로 컨테이너를 생성하고 실행하여 이미지를 관리하는 주체는 도커 서버이고, 이는 dockerd 프로세스로서 동작한다.
- 도커 엔진은 외부에서 API 입력을 받아 도커 엔진의 기능을 수행하는데, 도커 프로세스가 실행되어 서버로서 입력을 받을 준비가 된 상태를 **도커 데몬**이라고 한다.
- 도커 데몬은 API 입력을 받아 도커 엔진의 기능을 수행하는데, 이 API를 사용할 수 있도록 CLI를 제공하는 것이 도커 클라이언트다.
- 사용자가 docker로 시작하는 명령어를 입력하면 도커 클라이언트를 사용하는 것이며, 도커 클라이언트는 입력된 명령어를 로컬에 존재하는 도커 데몬에게 API로서 전달한다.
  - 이때 도커 클라이언트는 유닉스 소켓을 통해 도커 데몬의 API를 호출한다.
  - 도커 클라이언트가 사용하는 유닉스 소켓은 같은 호스트 내에 있는 도커 데몬에게 명령을 전달할 때 사용된다.
- 즉, 터미널 등으로 도커가 설치된 호스트에 접속해 docker 명령어를 입력하면 아래와 같은 과정으로 도커가 제어된다.
    1. 사용자가 docker ps 같은 도커 명령어를 입력한다.
    2. /usr/bin/docker는 /var/rum/docker.sock 유닉스 소켓을 사용해 도커 데몬에게 명령어를 전달한다.
    3. 도커 데몬은 이 명령어를 파싱하고 명령어에 해당하는 작업을 수행한다.
    4. 수행 결과를 도커 클라이언트에게 반환하고, 사용자에게 결과를 출력한다.
- 도커 데몬에 각종 옵션을 추가해 실행한다면, 위 순서에 별도의 과정이 포함될 수 있다.

## 2. 도커 데몬 실행
- 리눅스
  - 우분투에서는 `service docker start`와 `service docker stop` 명령어로 도커 데몬을 시작, 정지할 수 있다.
    - 도커가 설치되면 자동으로 서비스로 등록되므로 호스트가 재시작되더라도 자동으로 실행된다.
  - 레드햇 계열에서는 도커를 자동으로 실행하도록 설정하려면 `systemctl enable docker` 명령어를 입력한다.
  - 도커 서비스를 정지한 뒤 `dockerd` 명령어로 직접 실행할 수도 있다.
- 윈도우
  - C:\Program Files\Docker\Docker\resources를 환경변수로 지정하여 dockerd 명령어를 입력한다.

## 3. 도커 데몬 설정
    dockerd --help
- 위의 명령어로 도커 데몬에 적용할 수 있는 옵션을 찾아볼 수 있다.

### 3.1. 도커 데몬 제어: -H
- `-H` 옵션은 도커 데몬의 API를 사용할 수 있는 방법을 추가한다.
- 아무런 오션을 설정하지 않고 도커 데몬을 실행하면 도커 클라이언트를 위한 유닉스 소켓을 사용한다.
  - 즉, dockerd와 dockerd -H unix:///var/run/docker.sock은 같다.
- -H에 IP 주소와 포트 번호를 입력하면, 원격 API인 Docker Remote API로 도커를 제어할 수 있다.
  - Remote API는 도커 클라이언트와는 다르게 로컬에 있는 도커 데몬이 아니더라도 제어할 수 있으며, RESTful API 형식을 띠고 있으므로 HTTP 요청으로 도커를 제어할 수 있다.
- `dockerd -H tcp://0.0.0.0:2375`와 같이 도커 데몬을 실행하면, 호스트에 존재하는 모든 네트워크 인터페이스의 IP 주소와 2375번 포트를 바인딩해 입력을 받는다.
  - 위와 같이 Remote API만을 위한 바인딩 주소를 입력하면 유닉스 소켓은 비활성화되므로 도커 클라이언트를 사용할 수 없게 되며, docker로 시작하는 명령어를 사용할 수 없다.
  - 따라서, 일반적으로 밑과 같이 도커 클라이언트를 위한 유닉스 소켓과 Remote API를 위한 바인딩 주소를 동시에 설정한다.
  - `dockerd -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375`
    - 도커 클라이언트가 도커 데몬에게 명령어를 수행하도록 요청할 때도 내부적으로는 같은 API를 사용하므로, Remote API 또한 도커 클라이언트에서 사용 가능한 모든 명령어를 사용할 수 있다.

### 3.2. 도커 데몬에 보안 적용: --tlsverify
- 도커를 설치하면 기본적으로 보안 연결이 설정되어 있지 않다.
  - 보안이 적용되어 있지 않으면 Remote API를 위해 바인딩된 IP 주소와 포트 번호만 알면 도커를 제어할 수 있다.
- 다음 과정으로 보안을 적용하는 데 필요한 파일을 생성한다. (책 참고)
    - 서버측 파일 생성
        1. 인증서에 사용될 키를 생성한다.
        2. Public key를 생성한다.
        3. 서버 측에서 사용될 키를 생성한다.
        4. 서버 측에서 사용될 인증서를 위한 인증 요청 파일을 생성한다.
        5. 접속에 사용될 IP 주소를 extfile.cnf 파일로 저장한다.
        6. 서버 측의 인증서 파일을 생성한다.
    - 클라이언트 픅에서 사용할 파일 생성
        1. 클라이언트 측의 키 파일과 인증 요청 파일을 생성하고, extfile.xnf 파일에 extendedKeyUsage 항목을 추가한다.
        2. 다음 명령을 입력해 클라이언트 측의 인증서를 생성한다.
        3. 생성된 파일의 쓰기 권한을 삭제해 읽기 전용 파일로 만든다.
        4. 도커 데몬의 설정 파일이 존재하는 디렉토리인 ~/.docker로 도커 데목 측에서 필요한 파일을 옮긴다.

### 3.3. 도커 스토리지 드라이버 변경: --storage-driver
- 도커는 특정 스토리지 백엔드 기술을 사용해 도커 컨테이너와 이미지를 저장하고 관리한다.
- 도커를 사용하는 환경에 따라 스토리지 드라이버는 자동으로 정해지지만, 도커 데몬 실행 옵션에서 스토리지 드라이버를 변경할 수도 있다.
- 지원하는 드라이버로는 OverlayFS, AUFS, Btrfs, Devicemapper, VFS, ZFS 등이 있다.
  - 이 가운데 하나만 선택해 도커 데몬에 적용할 수 있으며, 적용된 스토리지 드라이버에 따라 컨테이너와 이미지가 별도로 생성된다.

## 4. 도커 데몬 모니터링

### 4.1. 도커 데몬 디버그 모드
    dockerd -D
- 도커 데몬을 디버그 옵션으로 실행하면 도커 데몬에서 어떤 일이 일어나고 있는지 가장 확실하고 정확하고 자세히 알아낸다.
- Remote API의 입출력뿐만 아니라 로컬 도커 클라이언트에서 오가는 모든 명령어를 로그로 출력한다.

### 4.2. 도커 데몬 모니터링 명령어

#### 4.2.1. events
    docker events
    혹은
    docker system events
- 도커 데몬에 어떤 일이 일어나고 있는지를 실시간 스트림 로그로 보여준다.
- 컨테이너, 이미지, 볼륨, 네트워크, 플러그인 등에 관한 명령어의 수행 결과가 출력된다.
- `-filter` 옵션으로 원하는 정보만 출력하도록 설정할 수 있다.
  - 출력의 종류는 container, image, volume, network, plugin, daemon이다.
  - 예) docker events --filter 'type=image'
  - type뿐 아니라 특정 컨테이너와 이미지로 생성된 이미지, 라벨 등으로 필터를 설정할 수도 있다.

#### 4.2.2. stats
    docker stats
- 실행 중인 모든 컨테이너의 자원 사용량을 스트림으로 출력한다.
  - CPU, 메모리 제한 및 사용량, 네트워크 입출력, 블록 입출력 정보를 출력한다.
- 스트림이 아닌 한 번만 출력하는 방식으로 사용하고 싶다면 `--no-stream` 옵션을 추가한다.
  - 예) `docker stats --no-stream`

#### 4.2.3. system df
- 도커에서 사용하고 있는 이미지, 컨테이너, 로컬 볼륨의 총 개수 및 사용 중인 개수, 크기, 삭제함으로써 확보 가능한 공간을 출력한다.

### 4.3. CAdvisor
    docker run --volume=/:/rootfs:ro --volume=/var/run:/var/run:ro --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --volume=/dev/disk/:/dev/disk:ro --publish=8080:8080 --detach=true --name=cadvisor google/cadvisor:latest
- CAdvisor는 구글이 만든 컨테이너 모니터링 도구로, 컨테이너로서 간단히 설치할 수 있고 컨테이너별 실시간 자원 사용량 및 도커 모니터링 정보 들을 시각화해서 보여준다.
- 컨테이너 생성이 완료되면 호스트의 8080번 포트로 CAdvisor 대시보드에 접근할 수 있다.
- [Subcontainers] 항목의 [/docker]을 클릭하면 도커 데몬의 정보, 컨테이너의 목록을 보여주는 페이지로 이동한다.
- 단일 도커 호스트만을 모니터링할 수 있다는 한계가 있다.
  - 이 경우, 쿠버네티스나 스웜 모드 등과 같은 오케스트레이션 툴을 설치한 뒤에 프로메테우스, InfluxDB 등을 이용해 여러 호스트의 데이터를 수집한다.

## 5. Remote API 라이브러리를 이용한 도커 사용
- 컨테이너 애플리케이션이 수행해야 할 작업이 많거나 애플리케이션 초기화 등에 복잡한 과정이 포함되어 있다면, 도커를 제어하는 라이브러리를 이용해 쉽게 해결할 수 있다.
- 도커 SDK 홈페이지(https://docs.docker.com/engine/api/sdk/)에서 Remote API를 래핑해서 사용하기 쉽게 만들어 놓은 라이브러리 목록을 확인할 수 있다.