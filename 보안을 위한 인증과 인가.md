# 보안을 위한 인증과 인가 : ServiceAccount와 RBAC
- **서비스 어카운트**는 **RBAC**을 기반으로 하는 쿠버네티스의 보안 기능이다.
  - 서비스 어카운트는 사용자 또는 애플리케이션 하나에 해당하며, RABC을 통해 특정 명령을 실행할 수 있는 권한을 서비스 어카운트에 부여한다.
  - 권한을 부여받은 서비스 어카운트는 해당 권한에 해당하는 기능만 사용할 수 있다.
- kubectl 명령어를 사용하는 권한은 최상위 권한이다.
  - 쿠버네티스의 API에 접근하는 애플리케이션을 운영 환경에 배포하거나, 여러 명의 사용자가 동시에 쿠버네티스를 사용해야 한다면 최상위 권한을 사용하지 않는 것이 좋다.

## 1. 쿠버네티스의 권한 인증 과정
1. kubectl 명령어는 쿠버네티스 API 서버의 HTTP 핸들러에 요청을 전송한다.
2. API 서버는 해당 클라이언트에 대한 인증과 인가를 한다.
3. 어드미션 컨트롤러라는 별도의 단계를 거친 뒤 요철을 받는 기능을 수행한다.
- 설치 도구를 이용하여 쿠버네티스를 설치할 때 설치 도구가 자동으로 kubectl이 관리자 권한을 갖도록 설정한다.
  - **~/.kube/config** 파일에서 확인할 수 있다.
- kubectl을 사용할 때는 ~/.kube/config 파일에 저장된 설정을 읽어 들여 쿠버네티스 클러스터를 제어한다.
  - 이 파일에 저장된 내용 중에서 user 항목에는 인증을 위한 데이터가 설정되어 있다.

## 2. 서비스 어카운트와 롤, 클러스터 롤
- 서비스 어카운트는 체계적으로 권한을 관리하기 위한 쿠버네티스 오브젝트이다.
  - 네임스페이스에 속하는 오브젝트로, **serviceaccount** 또는 **sa**라는 이름으로 사용할 수 있다.
  - `kubectl get sa`
  - `kubectl create sa [이름]`나 `kubectl delete sa [이름]`명령어로 서비스 어카운트를 생성하거나 삭제할 수 있다.
  - **--as** 옵션을 사용하면 임시로 특정 서비스 어카운트를 사용할 수 있다.
    - 예) `kubectl get services --as system:serviceaccount:default:gowns764`
      - system:serviceaccount는 인증을 위해 서비스 어카운트를 사용한다는 것을 나타내며, default:gowns764는 default 네임스페이스의 gowns764 서비스 어카운트를 의미한다.
  - 서비스 어카운트에 적절한 권한을 부여해야만 쿠버네티스의 기능을 제대로 사용할 수 있다.
- 쿠버네티스에서 권한을 부여하는 방법에는 **롤**과 **클러스터 롤**이 있다.
  - 롤과 클러스터 롤은 부여할 권한이 무엇인지를 나타내는 쿠버네티스 오브젝트이다.
    - 롤은 네임스페이스에 속하는 오브젝트이므로, 네임스페이스에 속하는 오브젝트들에 대한 권한을 정의할 때 쓰인다.
  - 클러스터 롤은 클러스터 단위의 권한을 정의할 때 사용한다.
    - 네임스페이스에 속하지 않는 오브젝트뿐만 아니라, 클러스터 전반에 걸친 기능을 사용하기 위해서도 클러스터 롤을 정의할 수 있으며, 여러 네임스페이스에서 반복적으로 사용되는 권한을 클러스터 롤로 만들러 재사용하는 것도 가능하다.
- `kubectl get role` 명령어는 현재 네임스페이스의 롤 목록만을 출력하지만, `kubectl get clusterrole` 명령어는 클러스터 자체에 존재하는 모든 클러스터 롤의 목록을 출력한다.
- 롤을 사용하기 위해 YAML 파일을 작성한다.
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: default
  name: service-reader
rules:
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list"]
```
- **apiGroup**
  - 대상이 될 오브젝트의 API 그룹
- **resources**
  - 대상이 될 오브젝트의 이름
- **verbs**
  - 어떠한 동작을 허용할 것인지 명시
- 롤은 특정 기능에 대한 권한만을 정의하는 오브젝트이기 때문에 롤을 생성하는 것만으로는 서비스 어카운트나 사용자에게 권한이 부여되지 않는다.
  - 롤을 특정 대상에게 부여하려면 **롤 바인딩** 오브젝트를 통해 특정 대상과 롤을 연결해야 한다.
  - 예)
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: service-reader-rolebinding
  namespace: default
subjects:
- kind: ServiceAccount
  name: gowns764
  namespace: default
roleRef:
  kind: Role
  name: service-reader
  apiGroup: rbac.authorization.k8s.io
```
- 롤 바인딩에서는 어떠한 대상을 어떠한 롤에 연결할 것인지 정의한다.
- 사비스의 목록을 확인할 수 있는 권한을 부여받았기 때문에 kubectl get svc 명령어를 사용할 수 있으나, 서비스 어카운트에 부여되지 않은 다른 기능은 사용할 수 없다.

### 2.1. 롤 vs 클러스터 롤
- 롤과 롤 바인딩은 네임스페이스에 한정되는 오브젝트이다.
- 노드, 퍼시스턴트 볼륨 등과 같이 네임스페이스에 종속되지 않는 오브젝트에는 롤 대신 클러스터 롤을 사용한다.
- 클러스터 롤은 클러스터 단위의 리소스에 대해 권한을 정의하기 위해 사용한다.
- YAML 파일의 내용은 kind가 ClusterRole로 설정되어 있다는 것을 제외하면 롤과 거의 같다.

### 2.2. 여러 개의 클러스터 롤을 조합해서 사용하기
- 자주 사용되는 클러스터 롤을 다른 클러스터 롤에 포함시켜 재사용하는 것을 **클러스터 롤 애크리게이션**이라고 한다.
- YAML 파일의 metadata.labels에 **aggregationRule.ClusterRoleSelectors** 항목을 추가한다.
- 클러스터 롤에 포함시키고자 하는 다른 클러스터 롤을 matchLabels의 라벨 셀텍터로 선택하면 하위 클러스터 롤에 포함되어 있는 권한을 그대로 부여받을 수 있다.
- 클러스터 롤 애그리게이션을 사용하면 여러 개의 클러스터 롤 권한을 하나의 클러스터 롤에 합쳐서 사용할 수도 있으며, 여러 단계의 클러스터 롤 권한 상속 구조를 만들 수도 있다.