# 도커 스웜

## 1. 도커 스웜을 사용하는 이유
- 하나의 호스트 머신에서 도커 엔진을 구동하다가 자원이 부족하면, 일반적으로 여러 대의 서버를 클러스터로 만들어 자원을 확장한다.
- 그러나 이는 쉬운 작업이 아니며 스케줄러, 로드밸런서, 고가용성 보장 등의 문제가 있는데 이를 해결하는 방법이 **도커 스웜**과 **스웜 모드**이다.

## 2. 스웜 클래식과 도커 스웜 모드
- 스웜 클래식과 스웜 모드는 여러 대의 도커 서버를 하나의 클러스터로 만들어 컨테이너를 생성하는 여러 기능을 제공한다.
- 도커 스웜에는 두 가지 종류가 있다.
    1. **스웜 클래식**
       - 여러 대의 도커 서버를 하나의 지점에서 사용하도록 단일 접근점을 제공한다.
       - 일반적인 도커 명령어와 도커 API로 클러스터의 서버를 제어하고 관리하는 기능을 제공한다.
       - 분산 코디네이터, 에이전트 등이 별도로 실행되어야 한다.
    2. **스웜 모드** (권장!)
       - 마이크로사비스 아키텍쳐의 컨테이너를 다루기 위한 클러스터링 기능에 초점을 맞춘다.
       - 같은 컨테이너를 동시에 여러 개 생성해 필요에 따라 유동적으로 컨테이너의 수를 조절할 수 있으며, 컨테이너로의 연결을 분산하는 로드밸런싱 기능을 자체적으로 지원한다.
       - 클러스터링을 위한 모든 도구가 도커 엔진 자체에 내장되어 있기 때문에 상대적으로 쉽게 서버 클러스터를 구축할 수 있다.

## 3. 스웜 모드
- **docker info** 명령어를 통해 도커 엔진의 스웜 모드 클러스터 정보를 확인할 수 있다.
  - 단일 도커 서버에서 사용중일 때는 스웜 모드의 상태가 비활성(inactive)으로 설정되어 있다.

### 3.3.1. 도커 스웜 모드의 구조
- 스웜 모드는 **매니저 노드**와 **워커 노드**로 구성되어 있다.
  - 워커 노드는 실제로 컨테이너가 생성되고 관리되는 도커 서버이다.
  - 매니저 노드는 워커 노드를 관리하기 위한 도커 서버이다.
    - 매니저 노드에도 컨테이너가 생성될 수 있다.
    - 즉, 매니저 노드는 기본적으로 워커 노드의 역할을 포함하고 있다.
- 매니저 노드는 1개 이상이 있어야 하지만, 워커 노드는 없을 수도 있다.
  - 매니저 노드가 워커 노드의 역할도 포함하고 있어, 매니저 모드만으로도 스웜 클러스터를 구성할 수 있기 때문이다.
  - 그러나, 일반적으로 워커 노드와 매니저 노드를 구분해서 사용하는 것을 권장한다.
- 실제 운영 환경에서 스웜 모드로 도커 클러스터를 구설하려면 매니저 노드를 다중화하는 것을 권장한다.
  - 매니저의 부하를 분산하고 특정 매니저 노드가 다운됐을 때 정상적으로 스웜 클러스터를 유지할 수 있기 때문이다.
- 스웜 모드는 매니저 노드의 절반 이상에 장애가 생길 경우, 장애가 생긴 매니저 노드가 복구될 때까지 클러스터의 운영을 중단한다.
  - 매니저 노드 사이에 네트워크 파티셔닝과 같은 현상이 발생했을 경우, 짝수 개의 매니저로 구성한 클러스터는 운영이 중단될 수도 있지만, 홀수 개로 구성했을 경우에는 과반수 이상이 유지되는 쿼럼 매니저에서 운영을 계속할 수 있다.
    - 따라서, 스웜 매니저는 가능한 한 홀수 개로 구성하는 것이 권장된다.

### 3.3.2. 도커 스웜 모드 클러스터 구축
1. **docker swarm init** 명령어를 입력해 매니저 역할을 할 서버에서 스웜 클러스터를 시작한다.
   - 예) docker swarm init --advertise-addr 192.168.0.100
   - **--advertise-addr**에는 다른 도커 서버가 매니저 노드에 접근하기 위한 IP 주소를 입력한다.
   - 출력 결과 중 **docker swarm join** 명령어는 새로운 워커 노드를 스웜 클러스터에 추가할 때 사용된다.
   - **--token** 옵션에 사용된 토큰 값은 새로운 노드를 해당 스웜 클러스터에 추가하기 위한 비밀키이다.
2. **docker swarm join --token [매니저 노드의 토큰 값과 IP:포트]** 명령어를 각 워커 노드에서 입력하여 워커 노드를 추가한다.
3. 매니저 노드에서 **docker node ls** 명령어를 입력하여 특정 도커 서버가 정상적으로 스웜 클러스터에 추가됐는지 확인한다.
   - 출력 결과 중 ID 옆에 *가 붙어 있는 노드가 현재서버이다.
- 매니저 노드를 추가하기 위한 토큰은 **docker swarm join-token manager** 명령어로 확인할 수 있다.
- 워커 노드를 추가하기 위한 토큰은 **docker swarm join-token worker** 명령어로 확인할 수 있다.
- 토큰을 갱신하려면 **docker swarm join-token --rotate [변경할 토큰의 대상]** 명령어를 입력한다.
- 추가된 워커 노드를 삭제하고 싶으면 해당 워커 노드에서 **docker swarm leave** 명령어를 입력한다.
  - 이 명령어로 스웜 모드를 해제하면 매니저 노드는 해당 워커 노드의 상태를 Down으로 인지하기 때문에, 매니저 노드에서 **docker node rm [해당 노드의 호스트 이름]** 명령어로 삭제해야 한다.
    - 해당 노드의 호스트 이름은 ID의 앞자리 중 일부만 사용해 제어할 수 있다.
- 매니저 노드는 **docker swarm leave --force** 명령어로 삭제할 수 있다.
  - 매니저 노드를 스웜 클러스터에서 삭제하면, 해당 매니저 노드에 저장되어 있던 클러스터의 정보도 삭제된다.
  - 스웜 클러스터에 매니저 노드가 단 한개만 존재할 때 매니저 노드를 삭제하면 해당 스웜 클러스터는 더 이상 사용하지 못하는 상태가 된다.
- 워커 노드를 매니저 노드로 변경하려면 **docker node promote [워커 노드]** 명령어를 사용한다.
- 매니저 노드를 워커 노드로 변경하려면 **docker node demote [매니저 노드]** 명령어를 사용한다.
  - 단, 매니저 노드가 1개일 때 매니저 노드에 대해 demote 명령어를 사용할 수 없다.
  - 매니저 리더 노드에 demote 명령어를 사용하면 다른 매니저 노드 중 새로운 리더를 선출한다.