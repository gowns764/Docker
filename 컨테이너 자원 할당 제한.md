# 컨테이너 자원 할당 제한
- run, create 명령어에서 컨테이너의 자원 할당량을 조정하도록 옵션을 입력할 수 있다.
- 아무럽 옵션을 입력하지 않으면 컨테이너는 호스트의 자원을 제한 없이 쓸 수 있다.
- **docker inspect [컨테이너 이름]** 명령어로 설정된 자원 제한을 확인할 수 있다.
  - **HostConfig** 항목에 있다.
- 이미 설정된 컨테이너의 자원 제한을 변경하려면 **docker update [변경할 자원 제한] [컨테이너 이름]** 명령어를 사용한다.
- ctop (https://github.com/bcicen/ctop)으로 각 컨테이너의 자원 사용량을 알 수 있다.

## 1. 컨테이너 메모리 제한
    --memory=["사용량"]
- 컨테이너의 메모리를 제한할 수 있다.
- 입력할 수 있는 단위는 m, g이다.
- 제한할 수 있는 최소 메모리는 4MB이다.
- 컨테이너에서 동작하는 프로세스가 컨테이너에 할당된 메모리를 초과하면 컨테이너는 자동으로 종료된다.
- Swap 메모리는 기본적으로 메모리의 2배로 설정되지만, **--memory-swap** 옵션으로 별도로 지정할 수 있다.

## 2. 컨테이너 CPU 제한

### 2.1. --cpu-shares
    --cpu-shares [가중치]
- 컨테이너에 가중치를 설정해 해당 컨테이너가 CPU를 상대적으로 얼마나 사용할 수 있는지를 나타낸다.
  - 즉, 컨테이너에 CPU를 한 개씩 할당하는 게 아닌, CPU를 어느 비중만큼 나눠 사용할 것인지를 명시하는 옵션이다.
- 아무런 설정을 하지 않았을 때 컨테이너가 가지는 값은 1024로, 이는 CPU 할당에서 1의 비중을 의미한다.
- --cpu-shares의 값이 1024로 설정되어도, 호스트에 다른 컨테이너가 존재하지 않으면 CPU를 100% 사용한다.

### 2.2. --cpuset-cpus (권장!)
    --cpuset-cpus=[CPU 번호]
- 호스트에 CPU가 여러 개 있을 때 컨테이너가 특정 CPU만 사용하도록 설정한다.
  - **--cpuset-cpus="0,3"**은 1, 4번 째 CPU를 **--cpuset-cpus="0-2"는 1, 2, 3번째 CPU를 사용하도록 설정한다.**
  - 도커 설정에서 호스트에서 사용할 수 있는 CPU의 수를 늘려야 한다.

### 2.3. --cpu-period, --cpu-quota
    --cpu-period=[주기] --cpu-quota=[주기]
- 컨테이너의 CFS (Completely Fair Scheduler) 주기는 기본적으로 100ms로 설정되지만 run 명령어에 이 옵션들을 넣어서 변경할 수 있다.
- --cpu-period의 값은 기본적으로 100000이며, 이는 100ms를 뜻한다.
- --cpu-quota는 --cpu-period에 설정된 시간 중 CPU 스케줄링에 얼마나 할당할 것인지를 설정한다.
  - 즉, 컨테이너는 '[--cpu-quota 값] / [--cpu-period 값]'만큼 CPU 시간을 할당받는다.
    - 그 만큼 CPU 성능이 감소한다는 의미이다.

### 2.4. --cpus
    --cpus=[비율]
- --cpu-period, --cpu-quota와 동일한 기능을 하지만, 직관적으로 CPU의 개수를 직접 지정하는 옵션이다.
- 예를 들어, --cpus=0.5는 50%의 CPU를 사용하겠다는 의미이다.

## 3. Block I/O 제한
- 컨테이너를 생성할 때 아무런 옵션도 설정하지 않으면, 컨테이너 내부에서 파일을 읽고 쓰는 대역폭에 제한이 설정되지 않는다.
- run 명령어에서 **--device-write-bps**, **--device-read-bps**, **--device-write-iops**, **--device-read-iops** 옵션을 지정헤 블록 입출력을 제한할 수 있다.
- 단, Direct I/O의 경우에만 블록 입출력이 제한되며, Buffered I/O는 제한되지 않는다.
- **--device-write-bps**, **--device-read-bps**는 쓰고 읽는 작업의 초당 제한을 설정하며, kb, mb, gb 단위로 제한할 수 있다.
  - **옵션 [디바이스 이름]:[값]**
  - 도커 엔진에서 루프 디바이스를 스토리지로 사용하고 있다면, 디바이스 이름을 /dev/loop0로 입력한다.
- **--device-write-iops**, **--device-read-iops**에는 상대적인 값을 입력한다.

## 4. 스토리지 드라이버와 컨테이너 저장 공간 제한
- 도커의 스토리지 드라이버나 파일 시스템 등이 특정 조건을 만족하는 경우에만, 컨테이너 내부의 저장 공간을 제한하는 기능을 제한적으로 사용할 수 있다.
  - 단, 모든 스토리지 드라이버에서 컨테이너의 저장 공간을 제한할 수 있는 것은 아니다.
  - 또한, 컨테이너 내부에서 개발하고 있거나, 그 외의 다른 특별한 상황이 아니라면 컨테이너 자체가 Stateful한 것은 바람직하지 않다.