# 인그레스(Ingress)
- 인그레스는 사전적으로 외부에서 내부로 향하는 것을 의미한다.
  - 인그레스 트래픽은 외부에서 서버로 유입되는 트래픽이다.
  - 인그레스 네트워크는 인그레스 트래픽을 처리하기 위한 네트워크이다.
- 쿠버네티스에서 인그레스는 외부 요청을 어떻게 처리할 것인지를 네트워크 7계층 레벨에서 정의하는 오브젝트이다.
- 인그레스 오브젝트가 담당할 수 있는 기본 기능은 다음과 같다.
  - **외부 요청의 라우팅**
    - 특정 경로로 들어온 요청을 어떠한 서비스로 전달할지 정의하는 라우팅 규칙을 설정한다.
  - **가상 호스트 기반의 요청 처리**
    - 같은 IP에 대해 다른 도메인 이름으로 요청이 도착했을 때, 어떻게 처리할 것인지를 정의한다.
  - **SSL/TLS 보안 연결 처리**
    - 여러 개의 서비스로 요청을 라우팅 할 때, 보안 연결을 위한 인증서를 적용한다.

## 1. 인그레스를 사용하는 이유
- 예를 들어, 인그레스를 사용하지 않을 경우 애플리케이션이 3개의 디플로이먼트로 생성되어 있을 때, 각 디플로이먼트를 외부에 노출해야 한다면 NodePort나 LoadBalancer 타입의 서비스 3개를 생성한다.
- 위의 방식은 서비스마다 세부적인 설정을 할 때 추가적인 복잡성이 발생한다.
  - SSL/TLS 보안 연결, 접근 도메인 및 클라이언트 상테에 기반한 라우팅 등을 구현하려면 각 서비스와 디플로이먼트에 대해 일일히 설정을 해야 하기 때문이다.
- 인스레스 오브젝트를 사용하면 URL 엔드포인트를 단 하나만 생성함으로써 쉽게 해결할 수 있다.
  - 클라이언트는 인그레스의 URL로만 접근하게 되며, 해당 요청은 인그레스에서 정의한 규칙에 따라 처리된 뒤 적절한 디플로이먼트의 포드로 전달된다.
- 외부 요청에 대한 처리 규칙을 쿠버네티스 자체의 기능으로 편리하게 관리할 수 있다는 것이 인그레스의 핵심이다.

## 2. 인그레스의 구조
- `kubectl get ingress` 명령어로 인그레스의 목록을 확인할 수 있다.
  - **ingress**는 **ing**로 줄일 수 있다.
- 인그레스를 생성하려면 YAML 파일로 인그레스를 정의한다.
```yaml
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: ingress-example
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    kubernetes.io/ingress.class: "nginx"
spec:
  rules:
  - host: gowns764.example.com
    http:
      paths:
      - path: /echo-hostname
        backend:
          serviceName: hostname-service
          servicePort: 80
```
- **host**
  - 해당 도메인으로 접근하는 요청에 대해서 처리 규칙을 적용한다.
  - 여러 개의 host를 정의하여 사용할 수 있다.
- **path**
  - 해당 경로에 들어온 요청을 어느 서비스로 전달할 것인지를 정의한다.
  - 여러 개의 path를 정의하여 경로를 처리할 수 있다.
- **serviceName, servicePort**
  - path로 들어온 요청이 전달될 서비스와 포트이다.
- 인그레스는 단지 요청을 처리하는 규칙을 정의하는 선언적인 오브젝트일 뿐, 외부 요청을 받아들일 수 있는 실제 서버가 아니기 때문에, 그저 인그레스만 생성하면 아무 일도 일어나지 않는다.
  - 인그레스는 **인그레스 컨트롤러**라는 특수한 서버에 적용해야만 규칙을 사용할 수 있다.
  - 즉, 실제로 외부 요청을 받아들이는 것은 인그레스 컨트롤러 서버이며, 이 서버가 인그레스 규칙을 로드하여 사용한다.
  - 따라서, 쿠버네티스의 인그레스는 반드시 인그레스 컨트롤러러는 서버와 함께 사용해야 한다.
  - 인그레스 컨트롤러 서버의 종류에는 **Nginx 웹 서버 인그레스 컨트롤러** 등이 있다.
- (이하는 나중에 다시~~~)

### 2.1.1. 인그레스 컨트롤러의 동작 원리 이해
- 인그레스를 사용하는 방법의 순서는 다음과 같다.
1. 공식 깃허브에서 제공되는 YAML 파일로 Nginx 인그레스 컨트롤러를 생성한다.
2. Nginx 인그레스 컨트롤러를 외부로 노출하기 위한 서비스를 생성한다.
3. 요청 처리 규칙을 정의하는 인그레스 오브젝트를 생성한다.
   - 인그레스를 생성하면 인그레스 컨트롤러는 자동으로 인그레스를 로드하여 Nginx 웹 서버에 적용한다.
   - 이를 위해 Nginx 인그레스 컨트롤러는 항상 인그레스 리소스의 상태를 지켜보며, 기본적으로 모든 네임스페이스의 인그레스 리소스를 읽어와 규칙을 적용한다.
4. Nginx 인그레스 컨트롤러로 들어온 요청은 인그레스규칙에 따라 적절한 서비스로 전달된다.
- 특정 경로와 호스트 이름으로 들어온 요청은 인그레스에 정의된 규칙에 따라 서비스로 전달된다.
  - 하지만, 요청이 실제로 그 서비스로 전달되는 것은 아니며, Nginx 인그레스 컨트롤러는 서비스에 의해 생성된 엔트포인트로 요청을 직접 전달한다.
  - 즉, 서비스의 ClusterIP가 아닌 엔드포인트의 실제 종착 지점들로 요청이 전달된다.
  - 이러한 동작을 쿠버네티스에서는 **바이패스**라고 한다.

## 3. 인그레스의 세부 기능 : annotaion을 이용한 설정
- 인그레스는 YAML 파일의 주석 항목을 정의함으로써 다양한 옵션을 사용할 수 있다.
- **kubernetes.io/intress.class**는 해당 인그레스 규칙을 어떤 인그레스 컨트롤러에 적용할 것인지를 의미한다.
  - Nginx, Kong, GKE 등 여러 가지 중 하나를 선택하여 사용할 수 있다.
  - 쿠버네티스 클러스터 자체에서 기본적으로 사용하도록 설정된 인그레스 컨트롤러가 존재하는 경우, 어떤 인그레스 컨트롤러를 사용할 것인지를 반드시 명시하는 것이 좋다.
  - 예를 들어, GKE에서 쿠버네티스를 사용하고 있다면 GKE에서 제공하는 인그레스 컨트롤러를 기본적으로 사용하도록 설정되어 있다.
- **nginx.ingress.kubernetes.io/rewrite-target**은 Nginx 인그레스 컨트롤러에서만 사용할 수 있는 기능이다.
  - 인그레스에 정의된 경로로 들어오는 요청을 **rewrite-target**에 설정된 경로로 전달한다.
  - **rewrite-target**은 Nginx의 캡쳐 그룹과 함께 사용할 때 유용한 기능이다.
    - 캡쳐 그룹이란 정규 표현식의 형태로 요청 경로 등의 값을 변수로서 사용할 수 있는 방법이다.
- 그 외에 Nginx 인그레스 컨트롤러에서 사용할 수 있는 주석은 공식 사이트에서 확인할 수 있다.

## 4. Nginx 인그레스 컨트롤러에 SSL/TLS 보안 연결 적용
- 인그레스 컨트롤러 지점에서 인증서를 적용해 두면 요청이 전달되는 애플리케이션에 대해 모두 인증서 처리를 한다.
  - 따라서, 인그레스 컨트롤러는 보안 연결을 수립하기 위한 일종의 게이트웨이 역할을 한다.
- 클라우드 환경에서 LoadBalancer 타입의 서비스를 사용하면, 클라우드 플랫폼 자체에서 관리해주는 인증서를 인그레스 컨트롤러에 적용할 수 있다.

## 5. 여러 개의 인그레스 컨트롤러 사용하기
- 별도의 값(클래스)을 적용한 Nginx 인그레스 컨트롤러를 생성해 kubernetes.io/ingress.class 주석을 해당 값으로 설정할 수 있다.